<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<title data-react-helmet="true">Geant4 examples | ML4Sim</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://your-docusaurus-test-site.com/docs/G4_Inference/G4_examples"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Geant4 examples | ML4Sim"><meta data-react-helmet="true" name="description" content="Par04"><meta data-react-helmet="true" property="og:description" content="Par04"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://your-docusaurus-test-site.com/docs/G4_Inference/G4_examples"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/G4_Inference/G4_examples" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/G4_Inference/G4_examples" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.7069df34.css">
<link rel="preload" href="/assets/js/runtime~main.71701159.js" as="script">
<link rel="preload" href="/assets/js/main.f9c432a9.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.png" alt="Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">ML4Sim</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Get started</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/DalilaSalamani/ML4Sim_Documentation.git" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Full and fast simulation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/ml_fastsim">Generative modeling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/ml_workflow">Machine learning workflow</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/ML_Model/training">Generative models for fast simulation</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/docs/G4_Inference/from_training_to_inference">Inference integration in Geant4</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/G4_Inference/from_training_to_inference">From ML training to Geant4 inference</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/G4_Inference/G4_examples">Geant4 examples</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/G4_Inference/inference_optimization">Inference optimization</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Geant4 examples</h1><h2 class="anchor anchorWithStickyNavbar_mojV" id="par04">Par04<a class="hash-link" href="#par04" title="Direct link to heading">â€‹</a></h2><p><strong><a href="https://gitlab.cern.ch/geant4/geant4/-/tree/master/examples/extended/parameterisations/Par04" target="_blank" rel="noopener noreferrer">Par04</a></strong> is a Geant4 example which demonstrates how to use ML techniques for the fast simulation of calorimeters, and how to incorporate inference libraries into C++ framework. The example depends on external libraries used for the ML inference. Currently, <strong><a href="https://github.com/lwtnn/lwtnn" target="_blank" rel="noopener noreferrer">LWTNN</a></strong> and <strong><a href="https://github.com/microsoft/onnxruntime" target="_blank" rel="noopener noreferrer">ONNXRuntime</a></strong> libraries can be used.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="calorimeter-setup">Calorimeter setup<a class="hash-link" href="#calorimeter-setup" title="Direct link to heading">â€‹</a></h3><p>The calorimeter in this example, is a setup of concentric cylinders of layers. Each layer consists of active and passive material (or just active material for homogeneous calorimeters). Energy deposits are scored in the detector using the cylindrical readout structure, centred around the particle momentum. In this example two detector geometries are used SiW and SciPb with a very granular segmentation (r,<!-- -->Ï†<!-- -->,z)=(18,50,45) described in the calorimeter setup and mesh definition of this page. </p><p>Detector and readout (mesh) used in the example macros are configured with following commands:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Detector Construction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Par04/detector/setDetectorInnerRadius </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> cm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Par04/detector/setDetectorLength </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Par04/detector/setNbOfLayers </span><span class="token number" style="color:#36acaa">90</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Par04/detector/setAbsorber </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> G4_W </span><span class="token number" style="color:#36acaa">1.4</span><span class="token plain"> mm </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Par04/detector/setAbsorber </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> G4_Si </span><span class="token number" style="color:#36acaa">0.3</span><span class="token plain"> mm </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## 2.325 mm of tungsten =~ 0.25 * 9.327 mm = 0.25 * R_Moliere</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Par04/mesh/setSizeOfRhoCells </span><span class="token number" style="color:#36acaa">2.325</span><span class="token plain"> mm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## 2 * 1.4 mm of tungsten =~ 0.65 X_0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Par04/mesh/setSizeOfZCells </span><span class="token number" style="color:#36acaa">3.4</span><span class="token plain"> mm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Par04/mesh/setNbOfRhoCells </span><span class="token number" style="color:#36acaa">18</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Par04/mesh/setNbOfPhiCells </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Par04/mesh/setNbOfZCells </span><span class="token number" style="color:#36acaa">45</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="training-data">Training data<a class="hash-link" href="#training-data" title="Direct link to heading">â€‹</a></h3><p>The full simulation samples for the two detector geometries (<strong>SiW</strong> and <strong>SciPb</strong>) are showers of electrons generated with an energy range from 1 GeV to 1 TeV (in powers of 2) and angles from 50<!-- -->Â°<!-- -->to 90<!-- -->Â°<!-- --> (in a step of 10<!-- -->Â°<!-- -->). Entrance angle of 90<!-- -->Â°<!-- -->means perpendicular to the z-axis. Ten thousand particle showers are simulated for each primary particle energy and angle.  </p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ml-model">ML model<a class="hash-link" href="#ml-model" title="Direct link to heading">â€‹</a></h3><p>The model used in this example was trained externally (in Python) on data from this examplesâ€™ full simulation. It is a Variational Autoencoder (VAE) composed of two stacked deep neural networks acting as encoder and decoder. The encoded distributions are constrained to be Gaussian distributions and the encoder is tasked to return the mean and the covariance matrix that describe these distributions. The loss function that is optimized during the training of the VAE is composed of a regularisation loss to minimize Kulback-Leibler divergence between encoded distributions and prior Gaussian distributions, a reconstruction loss to minimize the error by computing the binary cross-entropy between the input and its reconstruction version using the latent representation.</p><p>The VAE architecture used in this example comprises 4 hidden layers with width of 100,50,20,14 and 14,20,50,100 for the encoder and decoder respectively as shown in the figure below.</p><p><img src="/assets/images/Par04_MLModel-76726aa8315da4583b18ecb1bce8a55c.png" width="2482" height="776"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="validation">Validation<a class="hash-link" href="#validation" title="Direct link to heading">â€‹</a></h3><p>The three figures below show the validation plots comparing the full simulation to the (ML) fast simulation after using the inference with <strong>ONNXRuntime</strong>. The plots show the longitudinal, transverse profiles and simulation time for 64 GeV particles with an angle of 90<!-- -->Â°<!-- --> for the <strong>SiW</strong> geometry.</p><p><img src="/assets/images/Par04_LongProfile-617a6aee0eec31978d83ecbaa6fe2e3a.png" width="1500" height="1000">
<img src="/assets/images/Par04_LatProfile-cdfafe91c7c465b1d1754f5c3390ef69.png" width="1500" height="1000">
<img src="/assets/images/Par04_SimTime-1b8fea6d3967e7271d501ff98baec7b3.png" width="1500" height="1000"></p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>More details</h5></div><div class="admonition-content"><p>More details on this example can be found in the <strong><a href="https://geant4-userdoc.web.cern.ch/UsersGuides/ForApplicationDeveloper/html/Examples/extended/Par04.html#par04" target="_blank" rel="noopener noreferrer">Geant4 Book For Application Developers</a></strong>.</p></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/DalilaSalamani/ML4Sim_Documentation.git/docs/G4_Inference/G4_examples.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/G4_Inference/from_training_to_inference"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">From ML training to Geant4 inference</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/G4_Inference/inference_optimization"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Inference optimization</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#par04" class="table-of-contents__link toc-highlight">Par04</a><ul><li><a href="#calorimeter-setup" class="table-of-contents__link toc-highlight">Calorimeter setup</a></li><li><a href="#training-data" class="table-of-contents__link toc-highlight">Training data</a></li><li><a href="#ml-model" class="table-of-contents__link toc-highlight">ML model</a></li><li><a href="#validation" class="table-of-contents__link toc-highlight">Validation</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Get started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://indico.cern.ch/category/13860/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>ML4Sim<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://mattermost.web.cern.ch/ml4sim/channels/town-square" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Mattermost<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/DalilaSalamani/ML4Sim_Documentation.git" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022, CERN</div></div></div></footer></div>
<script src="/assets/js/runtime~main.71701159.js"></script>
<script src="/assets/js/main.f9c432a9.js"></script>
</body>
</html>